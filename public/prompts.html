<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connected - Prompt Management & Documentation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs/loader.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        
        .header {
            background: white;
            border-bottom: 1px solid #e5e5e7;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .header .status {
            color: #28a745;
            font-size: 0.9rem;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            border-right: 1px solid #e5e5e7;
            padding: 1rem;
            overflow-y: auto;
        }
        
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .tabs {
            display: flex;
            background: white;
            border-bottom: 1px solid #e5e5e7;
        }
        
        .tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active {
            border-bottom-color: #007aff;
            color: #007aff;
        }
        
        .tab:hover {
            background: #f8f9fa;
        }
        
        .tab-content {
            flex: 1;
            padding: 2rem;
            overflow: hidden;
        }
        
        .prompt-list {
            list-style: none;
        }
        
        .prompt-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .prompt-item:hover {
            background: #e9ecef;
        }
        
        .prompt-item.active {
            background: #007aff;
            color: white;
        }
        
        .prompt-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .prompt-description {
            font-size: 0.85rem;
            color: #666;
        }
        
        .prompt-item.active .prompt-description {
            color: rgba(255,255,255,0.8);
        }

        .prompt-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .prompt-item:hover .prompt-actions {
            opacity: 1;
        }

        .prompt-item.active .prompt-actions {
            opacity: 1;
        }

        .history-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: all 0.2s;
            color: inherit;
        }

        .history-btn:hover {
            background: rgba(0,0,0,0.1);
        }

        .prompt-item.active .history-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .editor-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .editor-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .editor-actions {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #007aff;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #0056b3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #545b62;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #138496;
        }
        
        .monaco-editor-container {
            flex: 1;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
        }
        
        .chat-interface {
            height: 100%;
            display: flex;
            flex-direction: column;
            background: white;
            border-radius: 12px;
            margin: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e7;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }
        
        .chat-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .chat-subtitle {
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }
        
        .message.user {
            align-items: flex-end;
        }
        
        .message.assistant {
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 80%;
            padding: 1rem;
            border-radius: 18px;
            line-height: 1.4;
            white-space: pre-wrap;
        }
        
        .message.user .message-bubble {
            background: #007aff;
            color: white;
        }
        
        .message.assistant .message-bubble {
            background: white;
            border: 1px solid #e5e5e7;
        }
        
        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid #e5e5e7;
            background: white;
            border-radius: 0 0 12px 12px;
        }
        
        .chat-input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }
        
        .chat-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid #e5e5e7;
            border-radius: 20px;
            resize: none;
            font-family: inherit;
            font-size: 1rem;
            max-height: 120px;
            outline: none;
        }
        
        .chat-input:focus {
            border-color: #007aff;
        }
        
        .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #007aff;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .send-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }
        
        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Loading indicator styles */
        .loading-indicator {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .loading-bubble {
            background: white;
            border: 1px solid #e5e5e7;
            border-radius: 18px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            max-width: 80%;
        }
        
        .loading-text {
            font-style: italic;
            color: #666;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Version History Modal Styles */
        .version-history-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .version-history-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .version-history-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .version-history-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .close-modal-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .version-history-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .version-list-panel {
            width: 400px;
            border-right: 1px solid #e5e5e7;
            display: flex;
            flex-direction: column;
        }

        .version-list-header {
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e5e7;
            font-weight: 600;
        }

        .version-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .version-item {
            padding: 1rem;
            border: 1px solid #e5e5e7;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .version-item:hover {
            background: #f8f9fa;
        }

        .version-item.active {
            background: #007aff;
            color: white;
            border-color: #007aff;
        }

        .version-item.current {
            border-color: #28a745;
            background: #d4edda;
        }

        .version-item.current.active {
            background: #28a745;
            color: white;
        }

        .version-number {
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .current-badge {
            background: #28a745;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .version-timestamp {
            font-size: 0.8rem;
            color: #666;
            margin: 0.25rem 0;
        }

        .version-item.active .version-timestamp {
            color: rgba(255,255,255,0.8);
        }

        .version-commit-message {
            font-size: 0.85rem;
            color: #666;
            font-style: italic;
            margin-top: 0.25rem;
        }

        .version-item.active .version-commit-message {
            color: rgba(255,255,255,0.9);
        }

        .version-preview-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .version-preview-header {
            padding: 1rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e5e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .version-preview-title {
            font-weight: 600;
        }

        .version-preview-actions {
            display: flex;
            gap: 0.5rem;
        }

        .version-preview-content {
            flex: 1;
            padding: 1rem;
            overflow: hidden;
        }

        .version-content-display {
            height: 100%;
            border: 1px solid #e5e5e7;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            padding: 1rem;
            overflow-y: auto;
            white-space: pre-wrap;
            background: #fafafa;
        }

        .version-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #666;
            font-style: italic;
        }
        
        .hidden {
            display: none !important;
        }
        
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            background: #28a745;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.error {
            background: #dc3545;
        }

        .notification.warning {
            background: #fd7e14;
        }
        
        .confirmation-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .confirmation-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        
        .confirmation-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }
        
        .confirmation-message {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.4;
        }
        
        .confirmation-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 200px;
            }
            
            .version-history-content {
                width: 95%;
                height: 90vh;
            }
            
            .version-history-body {
                flex-direction: column;
            }
            
            .version-list-panel {
                width: 100%;
                height: 300px;
                border-right: none;
                border-bottom: 1px solid #e5e5e7;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Connected - Prompt Management</h1>
        <div class="status"></div>
    </div>
    
    <div class="main-container">
        <div class="sidebar">
            <h3 style="margin-bottom: 1rem; color: #666;">Prompt Templates</h3>
            <ul class="prompt-list" id="promptList">
                <li class="prompt-item active" data-prompt="reducer.user.txt">
                    <div class="prompt-name">Conversation Reducer</div>
                    <div class="prompt-description">Core conversation processor and intent classifier</div>
                    <div class="prompt-actions">
                        <button class="history-btn" onclick="showVersionHistory('reducer.user.txt')" title="Version History">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </li>
                <li class="prompt-item" data-prompt="wildness.user.txt">
                    <div class="prompt-name">Wildness Response</div>
                    <div class="prompt-description">Handles initial wildness level responses with appropriate enthusiasm</div>
                    <div class="prompt-actions">
                        <button class="history-btn" onclick="showVersionHistory('wildness.user.txt')" title="Version History">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </li>
                <li class="prompt-item" data-prompt="general.user.txt">
                    <div class="prompt-name">General Questions</div>
                    <div class="prompt-description">Handles questions about completed itineraries</div>
                    <div class="prompt-actions">
                        <button class="history-btn" onclick="showVersionHistory('general.user.txt')" title="Version History">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </li>
                <li class="prompt-item" data-prompt="options.user.txt">
                    <div class="prompt-name">Options Presenter</div>
                    <div class="prompt-description">Lists service options and catalogs</div>
                    <div class="prompt-actions">
                        <button class="history-btn" onclick="showVersionHistory('options.user.txt')" title="Version History">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </li>
                <li class="prompt-item" data-prompt="selector.system.txt">
                    <div class="prompt-name">Service Selector</div>
                    <div class="prompt-description">AI logic for choosing optimal services</div>
                    <div class="prompt-actions">
                        <button class="history-btn" onclick="showVersionHistory('selector.system.txt')" title="Version History">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </li>
                <li class="prompt-item" data-prompt="response.user.txt">
                    <div class="prompt-name">Response Generator</div>
                    <div class="prompt-description">Creates natural language itinerary presentations</div>
                    <div class="prompt-actions">
                        <button class="history-btn" onclick="showVersionHistory('response.user.txt')" title="Version History">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </button>
                    </div>
                </li>
            </ul>
        </div>
        
        <div class="content-area">
            <div class="tabs">
                <button class="tab active" data-tab="editor">Direct Editor</button>
                <!-- <button class="tab" data-tab="chat">Ask Questions</button> -->
            </div>
            
            <div class="tab-content">
                <!-- Direct Editor Tab -->
                <div id="editor-tab" class="editor-container">
                    <div class="editor-header">
                        <div class="editor-title">reducer.user.txt</div>
                        <div class="editor-actions">
                            <button class="btn btn-info" onclick="showVersionHistory(currentPrompt)">Version History</button>
                            <button class="btn btn-primary" onclick="savePrompt()">Save Changes</button>
                        </div>
                    </div>
                    <div class="monaco-editor-container" id="monaco-container"></div>
                </div>
                
                <!-- Documentation Assistant Tab -->
                <div id="chat-tab" class="chat-interface hidden">
                    <div class="chat-header">
                        <div class="chat-title">Documentation Assistant</div>
                        <div class="chat-subtitle">Ask me anything about the Connected system, prompts, or codebase</div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <div class="message assistant">
                            <div class="message-bubble">Hi! I'm here to help you understand the Connected bachelor party planning system. I can explain:

• How the chatbot works and its conversation flow
• What each prompt template does and how to use them  
• The system architecture and technical details
• How to customize the chatbot's behavior
• What each component and file is responsible for
• Best practices for using the system

Feel free to ask me anything about the codebase, specific prompts, or how things work together. I'm here to help you understand everything without having to dig through documentation!</div>
                        </div>
                    </div>
                    
                    <div class="chat-input-container">
                        <div class="chat-input-wrapper">
                            <textarea 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Ask about the system, prompts, or how things work..."
                                rows="1"
                            ></textarea>
                            <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Version History Modal -->
    <div class="version-history-modal hidden" id="versionHistoryModal">
        <div class="version-history-content">
            <div class="version-history-header">
                <h2 class="version-history-title" id="versionHistoryTitle">Version History</h2>
                <button class="close-modal-btn" onclick="closeVersionHistory()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="version-history-body">
                <div class="version-list-panel">
                    <div class="version-list-header">
                        <span id="versionCount">Loading versions...</span>
                    </div>
                    <div class="version-list" id="versionList">
                        <!-- Version items will be populated here -->
                    </div>
                </div>
                
                <div class="version-preview-panel">
                    <div class="version-preview-header">
                        <div class="version-preview-title" id="versionPreviewTitle">Select a version to preview</div>
                        <div class="version-preview-actions">
                            <button class="btn btn-primary btn-sm" id="revertBtn" onclick="revertToVersion()" disabled>Revert to This Version</button>
                        </div>
                    </div>
                    <div class="version-preview-content">
                        <div class="version-content-display" id="versionContentDisplay">
                            <div class="version-loading">Select a version from the list to preview its content</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <!-- Confirmation Dialog -->
    <div class="confirmation-dialog hidden" id="confirmationDialog">
        <div class="confirmation-content">
            <div class="confirmation-title" id="confirmationTitle">Confirm Action</div>
            <div class="confirmation-message" id="confirmationMessage">Are you sure you want to proceed?</div>
            <div class="confirmation-actions">
                <button class="btn btn-secondary" onclick="closeConfirmation()">Cancel</button>
                <button class="btn btn-primary" id="confirmActionBtn" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>
    
    <script>
        let editor;
        let currentPrompt = 'reducer.user.txt';
        let prompts = {};
        let pendingAction = null;
        let currentVersionHistory = null;
        let selectedVersion = null;
        let currentVersionHistoryPrompt = null;
        let conversationHistory = [];
        
        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.52.2/min/vs' }});
        require(['vs/editor/editor.main'], function () {
            editor = monaco.editor.create(document.getElementById('monaco-container'), {
                value: 'Loading...',
                language: 'plaintext',
                theme: 'vs',
                wordWrap: 'on',
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                fontSize: 14,
                lineHeight: 22,
                padding: { top: 16, bottom: 16 }
            });
            
            loadPrompts();
        });
        
        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                switchTab(tabName);
            });
        });
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            document.getElementById('editor-tab').classList.toggle('hidden', tabName !== 'editor');
            document.getElementById('chat-tab').classList.toggle('hidden', tabName !== 'chat');
        }
        
        // Prompt list handling
        document.querySelectorAll('.prompt-item').forEach(item => {
            item.addEventListener('click', function(e) {
                // Don't select prompt if clicking the history button
                if (e.target.closest('.history-btn')) {
                    return;
                }
                
                const promptName = this.dataset.prompt;
                selectPrompt(promptName);
            });
        });
        
        function selectPrompt(promptName) {
            document.querySelectorAll('.prompt-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-prompt="${promptName}"]`).classList.add('active');
            
            currentPrompt = promptName;
            document.querySelector('.editor-title').textContent = promptName;
            
            // Switch to editor tab if currently on AI assistant
            const currentTab = document.querySelector('.tab.active').dataset.tab;
            if (currentTab !== 'editor') {
                switchTab('editor');
            }
            
            if (prompts[promptName]) {
                editor.setValue(prompts[promptName]);
            } else {
                loadPrompt(promptName);
            }
        }
        
        // Version History Functions
        async function showVersionHistory(promptName) {
            const url = `/api/prompts?filename=${encodeURIComponent(promptName)}&action=history&ts=${Date.now()}`;
            try {
                const resp = await fetch(url, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } });

                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

                const data = await resp.json();
                window.currentVersionHistoryPrompt = promptName;
                window.currentVersionHistory = data.versions || [];
                displayVersionHistory(window.currentVersionHistory);
                document.getElementById('versionCount').textContent = `${data.totalVersions ?? window.currentVersionHistory.length} versions`;
                
                document.getElementById('versionHistoryModal').classList.remove('hidden');
                document.getElementById('versionHistoryTitle').textContent = `Version History - ${promptName}`;
                
            } catch (e) {
                console.error('history failed:', e);
                showNotification('Failed to load version history', 'error');
                const list = document.getElementById('versionList');
                if (list) list.innerHTML = '<div class="version-loading">Failed to load version history</div>';
            }
        }
        
        function displayVersionHistory(versions) {
            const versionList = document.getElementById('versionList');
            versionList.innerHTML = '';
            
            versions.forEach((version, index) => {
                const versionDiv = document.createElement('div');
                versionDiv.className = `version-item ${version.isCurrent ? 'current' : ''}`;
                versionDiv.dataset.version = version.timestamp;
                versionDiv.dataset.index = index;
                
                const formatDate = (timestamp) => {
                    const date = new Date(timestamp);
                    return date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                versionDiv.innerHTML = `
                    <div class="version-number">
                        Version ${version.version}
                        ${version.isCurrent ? '<span class="current-badge">CURRENT</span>' : ''}
                    </div>
                    <div class="version-timestamp">${formatDate(version.timestamp)}</div>
                    ${version.commitMessage ? `<div class="version-commit-message">"${version.commitMessage}"</div>` : ''}
                `;
                
                versionDiv.addEventListener('click', function(e) {
                    if (e.target.closest('.version-action-btn')) {
                        return;
                    }
                    previewVersion(version.timestamp);
                });
                
                versionList.appendChild(versionDiv);
            });
        }
        
        async function previewVersion(versionTimestamp) {
            const version = (window.currentVersionHistory || []).find(v => v.timestamp === versionTimestamp);
            const isCurrent = !!version?.isCurrent;
            const url = isCurrent
                ? `/api/prompts?filename=${encodeURIComponent(window.currentVersionHistoryPrompt)}&ts=${Date.now()}`
                : `/api/prompts?filename=${encodeURIComponent(window.currentVersionHistoryPrompt)}&action=version&version=${encodeURIComponent(versionTimestamp)}&ts=${Date.now()}`;
            
            try {
                const resp = await fetch(url, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } });

                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

                const data = await resp.json();
                document.getElementById('versionContentDisplay').textContent = data?.content ?? '(no content)';
                    
                updateVersionSelection(versionTimestamp, version);
                
            } catch (e) {
                console.error('preview failed:', e);
                document.getElementById('versionContentDisplay').innerHTML =
                    '<div class="version-loading">Failed to load version content</div>';
                showNotification('Failed to load version content', 'error');
            }
        }

        function updateVersionSelection(versionTimestamp, version) {
            selectedVersion = versionTimestamp;
            
            document.querySelectorAll('.version-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[data-version="${versionTimestamp}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            const revertBtn = document.getElementById('revertBtn');
            
            if (revertBtn) {
                revertBtn.disabled = version?.isCurrent === true;
                
                if (version?.isCurrent) {
                    revertBtn.textContent = 'Current Version';
                } else {
                    revertBtn.textContent = 'Revert to This Version';
                }
            }
            
            const previewTitle = document.getElementById('versionPreviewTitle');
            if (previewTitle && version) {
                const versionText = version.isCurrent ? 'Current Version' : `Version ${version.version}`;
                previewTitle.textContent = `Preview: ${versionText}`;
            }
        }

        function revertToVersion() {
            if (!selectedVersion) {
                showNotification('Please select a version first', 'error');
                return;
            }
            revertToSpecificVersion(selectedVersion);
        }
        
        function revertToSpecificVersion(versionTimestamp) {
            const version = (window.currentVersionHistory || []).find(v => v.timestamp === versionTimestamp);
            
            closeVersionHistory();
            
            showConfirmation(
                'Revert to Version',
                `Are you sure you want to revert "${window.currentVersionHistoryPrompt || 'this prompt'}" to Version ${version?.version || 'Unknown'}? This will create a backup of the current version.`,
                () => performRevert(versionTimestamp)
            );
        }
        
        async function performRevert(versionTimestamp) {
            try {
                const response = await fetch(`/api/prompts?filename=${window.currentVersionHistoryPrompt}&action=revert&version=${versionTimestamp}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    prompts[window.currentVersionHistoryPrompt] = data.content;
                    
                    if (window.currentVersionHistoryPrompt === currentPrompt) {
                        editor.setValue(data.content);
                    }
                    
                    showNotification(`Successfully reverted to selected version`);
                    
                } else {
                    throw new Error('Failed to revert');
                }
            } catch (error) {
                showNotification('Failed to revert to version: ' + error.message, 'error');
            }
        }
        
        function closeVersionHistory() {
            document.getElementById('versionHistoryModal').classList.add('hidden');
            currentVersionHistory = null;
            selectedVersion = null;
            currentVersionHistoryPrompt = null;
        }
        
        document.getElementById('versionHistoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeVersionHistory();
            }
        });
        
        // API functions
        async function loadPrompts() {
            try {
                const response = await fetch('/api/prompts');
                const data = await response.json();
                prompts = data.prompts;
                
                if (prompts[currentPrompt]) {
                    editor.setValue(prompts[currentPrompt]);
                }
            } catch (error) {
                showNotification('Failed to load prompts', 'error');
            }
        }
        
        async function loadPrompt(promptName) {
            try {
                const response = await fetch(`/api/prompts?filename=${promptName}`);
                const data = await response.json();
                prompts[promptName] = data.content;
                editor.setValue(data.content);
            } catch (error) {
                showNotification('Failed to load prompt', 'error');
            }
        }
        
        async function savePrompt() {
            try {
                const content = editor.getValue();
                
                const commitMessage = prompt('Optional: Add a commit message for this version:');
                
                const response = await fetch(`/api/prompts?filename=${currentPrompt}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        content,
                        commitMessage: commitMessage || null
                    })
                });
                
                if (response.ok) {
                    prompts[currentPrompt] = content;
                    showNotification('Prompt saved successfully!');
                } else {
                    throw new Error('Failed to save');
                }
            } catch (error) {
                showNotification('Failed to save prompt', 'error');
            }
        }
        
        // Confirmation dialog
        function showConfirmation(title, message, action) {
            document.getElementById('confirmationTitle').textContent = title;
            document.getElementById('confirmationMessage').textContent = message;
            pendingAction = action;
            document.getElementById('confirmationDialog').classList.remove('hidden');
        }
        
        function closeConfirmation() {
            document.getElementById('confirmationDialog').classList.add('hidden');
            pendingAction = null;
        }
        
        function confirmAction() {
            if (pendingAction) {
                pendingAction();
                closeConfirmation();
            }
        }
        
        // Loading indicator functions
        function showChatLoadingIndicator() {
            hideChatLoadingIndicator();
            
            const messagesContainer = document.getElementById('chatMessages');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-indicator';
            loadingDiv.id = 'chat-loading-indicator';
            loadingDiv.innerHTML = `
                <div class="loading-bubble">
                    <span class="loading-text">Thinking about your question</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function hideChatLoadingIndicator() {
            const loadingIndicator = document.getElementById('chat-loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }
        
        // Documentation chat functionality
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Disable input and button during processing
            input.disabled = true;
            sendBtn.disabled = true;
            input.value = '';
            
            // Add user message
            addMessage('user', message);
            conversationHistory.push({ role: 'user', content: message });
            
            // Show loading indicator
            showChatLoadingIndicator();
            
            try {
                const response = await fetch('/api/ai-prompt-modifier', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        message,
                        currentPrompts: prompts,
                        conversationHistory: conversationHistory.slice(-10) // Send last 10 messages for context
                    })
                });
                
                const data = await response.json();
                
                // Hide loading indicator
                hideChatLoadingIndicator();
                
                // Add assistant response
                addMessage('assistant', data.response);
                conversationHistory.push({ role: 'assistant', content: data.response });
                
            } catch (error) {
                hideChatLoadingIndicator();
                const errorMessage = 'Sorry, I encountered an error while processing your question. Please try again.';
                addMessage('assistant', errorMessage);
                showNotification('Failed to get response', 'error');
            } finally {
                // Re-enable input and button
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }
        
        function addMessage(role, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageId = 'msg-' + Date.now();
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.id = messageId;
            messageDiv.innerHTML = `<div class="message-bubble">${content}</div>`;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }
        
        // Chat input handling
        document.getElementById('chatInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Auto-resize chat input
        document.getElementById('chatInput').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                
                const activeTab = document.querySelector('.tab.active').dataset.tab;
                if (activeTab === 'editor' && editor) {
                    savePrompt();
                    const saveBtn = document.querySelector('.btn-primary[onclick="savePrompt()"]');
                    if (saveBtn) {
                        saveBtn.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            saveBtn.style.transform = '';
                        }, 150);
                    }
                }
            }
        });
        
        // Close confirmation dialog when clicking outside
        document.getElementById('confirmationDialog').addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmation();
            }
        });
        
        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>